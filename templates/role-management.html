{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω vai tr√≤ - BaiTapNhom{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/role-management.css') }}">
{% endblock %}

{% block content %}
<div class="role-management-container">
    <div class="page-header">
        <h1>Qu·∫£n l√Ω vai tr√≤ ng∆∞·ªùi d√πng</h1>
        <p class="page-description">Ph√¢n quy·ªÅn v√† qu·∫£n l√Ω vai tr√≤ cho c√°c t√†i kho·∫£n trong h·ªá th·ªëng</p>
    </div>

    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>T√™n ƒëƒÉng nh·∫≠p</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>Email</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>Vai tr√≤ hi·ªán t·∫°i</th>
                    <th>Ph√≤ng ban</th>
                    <th>Thay ƒë·ªïi vai tr√≤</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for user in users %}
                <tr data-username="{{ user.username }}">
                    <td>{{ user.username }}</td>
                    <td>
                        <div class="name-inputs">
                            <input type="text" class="name-input" data-field="first_name" data-username="{{ user.username }}" value="{{ user.first_name or '' }}" placeholder="H·ªç">
                            <input type="text" class="name-input" data-field="middle_name" data-username="{{ user.username }}" value="{{ user.middle_name or '' }}" placeholder="T√™n ƒë·ªám">
                            <input type="text" class="name-input" data-field="last_name" data-username="{{ user.username }}" value="{{ user.last_name or '' }}" placeholder="T√™n">
                        </div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone_number }}</td>
                    <td>
                        <span class="role-badge role-{{ user.role_name|lower }}">{{ user.role_name }}</span>
                    </td>
                    <td>
                        <select class="department-select" data-username="{{ user.username }}">
                            <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                            {% for dept in departments %}
                            <option value="{{ dept.department_key }}" {% if user.department_key == dept.department_key %}selected{% endif %}>
                                {{ dept.department }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="role-select" data-username="{{ user.username }}">
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            {% for role in roles %}
                            <option value="{{ role.role_name }}" {% if user.role_key == role.role_key %}selected{% endif %}>
                                {{ role.role_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-save" onclick="saveUserInfo('{{ user.username }}')" disabled>
                                L∆∞u
                            </button>
                            <button class="btn-delete" onclick="deleteUser('{{ user.username }}')" title="X√≥a t√†i kho·∫£n">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="messageContainer"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const originalValues = {};

    document.querySelectorAll('tr[data-username]').forEach(row => {
        const username = row.dataset.username;
        const roleSelect = row.querySelector('.role-select');
        const firstNameInput = row.querySelector('input[data-field="first_name"]');
        const middleNameInput = row.querySelector('input[data-field="middle_name"]');
        const lastNameInput = row.querySelector('input[data-field="last_name"]');
        const departmentSelect = row.querySelector('.department-select');
        
        const selectedRoleOption = roleSelect.options[roleSelect.selectedIndex];
        const initialRole = selectedRoleOption ? selectedRoleOption.value : '';
        
        originalValues[username] = {
            role: initialRole,
            first_name: firstNameInput.value,
            middle_name: middleNameInput.value,
            last_name: lastNameInput.value,
            department_key: departmentSelect.value
        };

        function checkChanges() {
            const saveBtn = row.querySelector('.btn-save');
            const validRoles = ['ADMIN', 'VIEWER', 'EDITOR'];
            const roleChanged = roleSelect.value !== originalValues[username].role;
            
            if (roleChanged && (!roleSelect.value || !validRoles.includes(roleSelect.value))) {
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-active');
                return;
            }
            
            const hasChanges = 
                roleSelect.value !== originalValues[username].role ||
                firstNameInput.value !== originalValues[username].first_name ||
                middleNameInput.value !== originalValues[username].middle_name ||
                lastNameInput.value !== originalValues[username].last_name ||
                departmentSelect.value !== originalValues[username].department_key;
            
            if (hasChanges) {
                saveBtn.disabled = false;
                saveBtn.classList.add('btn-active');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-active');
            }
        }

        roleSelect.addEventListener('change', checkChanges);
        firstNameInput.addEventListener('input', checkChanges);
        middleNameInput.addEventListener('input', checkChanges);
        lastNameInput.addEventListener('input', checkChanges);
        departmentSelect.addEventListener('change', checkChanges);
    });

    function saveUserInfo(username) {
        const row = document.querySelector(`tr[data-username="${username}"]`);
        const roleSelect = row.querySelector('.role-select');
        const firstNameInput = row.querySelector('input[data-field="first_name"]');
        const middleNameInput = row.querySelector('input[data-field="middle_name"]');
        const lastNameInput = row.querySelector('input[data-field="last_name"]');
        const departmentSelect = row.querySelector('.department-select');
        const saveBtn = row.querySelector('.btn-save');

        const roleName = roleSelect.value;
        const firstName = firstNameInput.value.trim();
        const middleName = middleNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        const departmentKey = departmentSelect.value.trim();

        const validRoles = ['ADMIN', 'VIEWER', 'EDITOR'];
        const roleChanged = roleName !== originalValues[username].role;
        
        if (roleChanged && (!roleName || !validRoles.includes(roleName))) {
            showMessage('Vui l√≤ng ch·ªçn m·ªôt vai tr√≤ h·ª£p l·ªá (ADMIN, VIEWER ho·∫∑c EDITOR)', 'error');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = 'ƒêang l∆∞u...';

        const updateData = {
            username: username,
            first_name: firstName,
            middle_name: middleName,
            last_name: lastName,
            department_key: departmentKey
        };

        if (roleName && validRoles.includes(roleName)) {
            updateData.role_name = roleName;
        }
        
        fetch('/api/user/update-info', {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showMessage(`ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin cho ${username} th√†nh c√¥ng`, 'success');
                originalValues[username] = {
                    role: roleName || originalValues[username].role,
                    first_name: firstName,
                    middle_name: middleName,
                    last_name: lastName,
                    department_key: departmentKey
                };
                
                if (roleName) {
                    const roleBadge = row.querySelector('.role-badge');
                    roleBadge.textContent = roleName;
                    roleBadge.className = `role-badge role-${roleName.toLowerCase()}`;
                    roleSelect.value = roleName;
                }
                
                saveBtn.textContent = 'L∆∞u';
                
                const hasChanges = 
                    roleSelect.value !== originalValues[username].role ||
                    firstNameInput.value !== originalValues[username].first_name ||
                    middleNameInput.value !== originalValues[username].middle_name ||
                    lastNameInput.value !== originalValues[username].last_name ||
                    departmentSelect.value !== originalValues[username].department_key;
                
                if (!hasChanges) {
                    saveBtn.disabled = true;
                    saveBtn.classList.remove('btn-active');
                }
            } else {
                const errorMsg = data.error || 'C√≥ l·ªói x·∫£y ra';
                showMessage(errorMsg, 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = 'L∆∞u';
            }
        })
        .catch(error => {
            showMessage(`C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi ƒë·∫øn server: ${error.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'L∆∞u';
        });
    }

    function deleteUser(username) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n kh·ªèi h·ªá th·ªëng.`)) {
            return;
        }
        
        fetch('/api/user/delete', {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showMessage(data.message || `ƒê√£ x√≥a t√†i kho·∫£n ${username} th√†nh c√¥ng`, 'success');
                // X√≥a d√≤ng kh·ªèi b·∫£ng
                const row = document.querySelector(`tr[data-username="${username}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }
            } else {
                showMessage(data.error || 'C√≥ l·ªói x·∫£y ra khi x√≥a t√†i kho·∫£n', 'error');
            }
        })
        .catch(error => {
            showMessage(`C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi ƒë·∫øn server: ${error.message}`, 'error');
        });
    }

    function showMessage(message, type) {
        const container = document.getElementById('messageContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `flash-message flash-${type}`;
        messageDiv.textContent = message;
        container.innerHTML = '';
        container.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}