{% extends "base.html" %}

{% block title %}Tra c·ª©u th√¥ng tin kh√°ch h√†ng - Application{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer-search.css') }}">
{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h1>Tra c·ª©u th√¥ng tin kh√°ch h√†ng</h1>
        <p class="search-subtitle">Nh·∫≠p m√£ s·ªë thu·∫ø ƒë·ªÉ tra c·ª©u th√¥ng tin kh√°ch h√†ng</p>
    </div>

    <div class="search-content">
        <div class="search-form-section">
            <div class="search-box">
                <label for="taxCodeInput" class="input-label">M√£ s·ªë thu·∫ø</label>
                <div class="input-group">
                    <input 
                        type="text" 
                        id="taxCodeInput" 
                        class="tax-code-input" 
                        placeholder="Nh·∫≠p m√£ s·ªë thu·∫ø (t·ªëi ƒëa 11 ch·ªØ s·ªë)"
                        maxlength="11"
                    >
                    <button id="searchBtn" class="search-button">
                        <span class="search-icon">üîç</span> Tra c·ª©u
                    </button>
                </div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="resultSection" class="result-section" style="display: none;">
            <div class="result-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="result-title" style="margin: 0;">Th√¥ng tin kh√°ch h√†ng</h2>
                    <button id="exportCsvBtn" class="export-button" style="display: none;">
                        <span class="export-icon">üì•</span> Xu·∫•t CSV
                    </button>
                </div>
                <div class="result-content">
                    <div class="info-row">
                        <span class="info-label">T√™n doanh nghi·ªáp:</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                        <span class="info-value" id="customerAddress">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">T·ªânh th√†nh sau s√°p nh·∫≠p:</span>
                        <span class="info-value" id="newProvince">-</span>
                    </div>
                </div>
            </div>
            
            <div class="result-card" id="revenueCard" style="display: none;">
                <h2 class="result-title">T·ªïng doanh thu v√† s·ªë l∆∞·ª£ng container theo th√°ng</h2>
                <div class="revenue-table-container">
                    <table class="revenue-table" id="revenueTable">
                        <thead>
                            <tr id="revenueTableHeader"></tr>
                        </thead>
                        <tbody>
                            <tr id="revenueTableBody"></tr>
                            <tr id="containerTableBody"></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const taxCodeInput = document.getElementById('taxCodeInput');
    const searchBtn = document.getElementById('searchBtn');
    const errorMessage = document.getElementById('errorMessage');
    const resultSection = document.getElementById('resultSection');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    let currentCustomerData = null;

    taxCodeInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value;
        
        if (value.length > 11) {
            value = value.substring(0, 11);
            e.target.value = value;
        }
        
        hideError();
        hideResult();
    });

    taxCodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    searchBtn.addEventListener('click', performSearch);
    exportCsvBtn.addEventListener('click', exportToCsv);

    function validateTaxCode(taxCode) {
        if (!taxCode || taxCode.trim() === '') {
            showError('Vui l√≤ng nh·∫≠p m√£ s·ªë thu·∫ø');
            return false;
        }
        
        if (!/^\d+$/.test(taxCode)) {
            showError('M√£ s·ªë thu·∫ø ph·∫£i l√† to√†n c√°c ch·ªØ s·ªë');
            return false;
        }
        
        if (taxCode.length > 11) {
            showError('M√£ s·ªë thu·∫ø kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 11 k√Ω t·ª±');
            return false;
        }
        
        return true;
    }

    function performSearch() {
        const taxCode = taxCodeInput.value.trim();
        
        hideError();
        hideResult();
        
        if (!validateTaxCode(taxCode)) {
            return;
        }
        
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="search-icon">‚è≥</span> ƒêang t√¨m ki·∫øm...';
        
        fetch('{{ url_for("search_customer") }}', {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tax_code: taxCode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResult(data.data);
            } else {
                showError(data.error || 'Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng');
            }
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<span class="search-icon">üîç</span> Tra c·ª©u';
        })
        .catch(error => {
            console.error('Error:', error);
            showError('C√≥ l·ªói x·∫£y ra khi tra c·ª©u. Vui l√≤ng th·ª≠ l·∫°i.');
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<span class="search-icon">üîç</span> Tra c·ª©u';
        });
    }

    function displayResult(data) {
        currentCustomerData = data;
        document.getElementById('customerName').textContent = data.customer_name || '-';
        document.getElementById('customerAddress').textContent = data.address || '-';
        document.getElementById('newProvince').textContent = data.new_province || '-';
        
        if (data.monthly_revenue) {
            displayRevenueTable(data.monthly_revenue);
        }
        
        exportCsvBtn.style.display = 'inline-block';
        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function displayRevenueTable(monthlyData) {
        const revenueCard = document.getElementById('revenueCard');
        const tableHeader = document.getElementById('revenueTableHeader');
        const revenueTableBody = document.getElementById('revenueTableBody');
        const containerTableBody = document.getElementById('containerTableBody');
        
        if (!monthlyData || (!monthlyData.revenue && !monthlyData.container_count)) {
            revenueCard.style.display = 'none';
            return;
        }
        
        const monthlyRevenue = monthlyData.revenue || {};
        const containerCount = monthlyData.container_count || {};
        
        const allMonths = new Set([...Object.keys(monthlyRevenue), ...Object.keys(containerCount)]);
        const months = Array.from(allMonths).sort((a, b) => {
            const [monthA, yearA] = a.split('/').map(Number);
            const [monthB, yearB] = b.split('/').map(Number);
            if (yearA !== yearB) return yearA - yearB;
            return monthA - monthB;
        });
        
        if (months.length === 0) {
            revenueCard.style.display = 'none';
            return;
        }
        
        tableHeader.innerHTML = '<th>Th√°ng</th>';
        revenueTableBody.innerHTML = '<td><strong>Doanh thu</strong></td>';
        containerTableBody.innerHTML = '<td><strong>S·ªë l∆∞·ª£ng container</strong></td>';
        
        months.forEach(month => {
            const headerCell = document.createElement('th');
            headerCell.textContent = month;
            tableHeader.appendChild(headerCell);
            
            const revenueCell = document.createElement('td');
            const amount = monthlyRevenue[month] || 0;
            revenueCell.textContent = formatNumber(amount);
            revenueTableBody.appendChild(revenueCell);
            
            const containerCell = document.createElement('td');
            const count = containerCount[month] || 0;
            containerCell.textContent = formatNumber(count);
            containerTableBody.appendChild(containerCell);
        });
        
        revenueCard.style.display = 'block';
    }
    
    function formatNumber(num) {
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }

    function hideError() {
        errorMessage.style.display = 'none';
    }

    function hideResult() {
        resultSection.style.display = 'none';
        exportCsvBtn.style.display = 'none';
        currentCustomerData = null;
    }

    function exportToCsv() {
        if (!currentCustomerData) {
            showError('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
            return;
        }

        const taxCode = taxCodeInput.value.trim();
        if (!taxCode) {
            showError('Vui l√≤ng nh·∫≠p m√£ s·ªë thu·∫ø');
            return;
        }

        exportCsvBtn.disabled = true;
        exportCsvBtn.innerHTML = '<span class="export-icon">‚è≥</span> ƒêang xu·∫•t...';

        fetch('{{ url_for("export_customer_csv") }}', {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tax_code: taxCode })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            return response.json().then(data => {
                throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra khi xu·∫•t CSV');
            });
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `khach_hang_${taxCode}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            exportCsvBtn.disabled = false;
            exportCsvBtn.innerHTML = '<span class="export-icon">üì•</span> Xu·∫•t CSV';
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message || 'C√≥ l·ªói x·∫£y ra khi xu·∫•t CSV. Vui l√≤ng th·ª≠ l·∫°i.');
            exportCsvBtn.disabled = false;
            exportCsvBtn.innerHTML = '<span class="export-icon">üì•</span> Xu·∫•t CSV';
        });
    }
</script>
{% endblock %}

