{% extends "base.html" %}

{% block title %}Application{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1 class="welcome-title">Ch√†o m·ª´ng tr·ªü l·∫°i, <span class="username">{{ full_name }}</span>!</h1>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="features-grid {% if is_admin %}features-grid-4{% else %}features-grid-3{% endif %}">
            {% set can_access_ocr = user_role == 'ADMIN' or user_role == 'EDITOR' %}
            {% set show_ocr_disabled = user_role == 'VIEWER' %}
            
            {% if can_access_ocr %}
            <a href="{{ url_for('ocr') }}" style="text-decoration: none; color: inherit;">
            {% else %}
            <div style="text-decoration: none; color: inherit; pointer-events: none;">
            {% endif %}
                <div class="feature-card {% if show_ocr_disabled %}feature-card-disabled{% endif %}" style="--card-color: #667eea; --card-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-icon">üì∑</div>
                    <div class="card-content">
                        <h3 class="card-title">Qu√©t OCR</h3>
                        <p class="card-description">Qu√©t v√† nh·∫≠n d·∫°ng vƒÉn b·∫£n t·ª´ h√¨nh ·∫£nh, t√†i li·ªáu</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>
            {% if can_access_ocr %}
            </a>
            {% else %}
            </div>
            {% endif %}

            <a href="{{ url_for('customer_search') }}" style="text-decoration: none; color: inherit;">
                <div class="feature-card" style="--card-color: #f093fb; --card-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-icon">üîç</div>
                    <div class="card-content">
                        <h3 class="card-title">Tra c·ª©u th√¥ng tin kh√°ch h√†ng</h3>
                        <p class="card-description">T√¨m ki·∫øm v√† xem th√¥ng tin chi ti·∫øt kh√°ch h√†ng</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>
            </a>

            {% if is_admin %}
            <a href="{{ url_for('role_management') }}" style="text-decoration: none; color: inherit;">
                <div class="feature-card" style="--card-color: #fa709a; --card-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="card-icon">üë•</div>
                    <div class="card-content">
                        <h3 class="card-title">Qu·∫£n l√Ω vai tr√≤</h3>
                        <p class="card-description">Ph√¢n quy·ªÅn v√† qu·∫£n l√Ω vai tr√≤ ng∆∞·ªùi d√πng</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>
            </a>
            {% endif %}

            <a href="{{ url_for('dashboard_report') }}" style="text-decoration: none; color: inherit;">
                <div class="feature-card" style="--card-color: #4facfe; --card-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="card-icon">üìä</div>
                    <div class="card-content">
                        <h3 class="card-title">B√°o c√°o Dashboard</h3>
                        <p class="card-description">Xem th·ªëng k√™ v√† b√°o c√°o t·ªïng quan h·ªá th·ªëng</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>
            </a>
        </div>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-info">
                    <p class="stat-value" id="customer-count">0</p>
                    <p class="stat-label">T·ªïng s·ªë kh√°ch h√†ng</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-info">
                    <p class="stat-value" id="document-count">0</p>
                    <p class="stat-label">T√†i li·ªáu ƒë√£ qu√©t</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateStats(stats) {
        if (stats.customer_count !== undefined) {
            const countElement = document.getElementById('customer-count');
            if (countElement) {
                countElement.style.transition = 'all 0.3s ease';
                countElement.textContent = stats.customer_count;
            }
        }
        if (stats.document_count !== undefined) {
            const countElement = document.getElementById('document-count');
            if (countElement) {
                countElement.style.transition = 'all 0.3s ease';
                countElement.textContent = stats.document_count;
            }
        }
    }

    function fetchCustomerCount() {
        fetch('/api/customers/count', {
            method: 'GET',
            headers: getAuthHeaders()
        })
            .then(response => {
                if (response.status === 401) {
                    console.error('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unauthorized');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const countElement = document.getElementById('customer-count');
                    if (countElement) {
                        countElement.style.transition = 'all 0.3s ease';
                        countElement.textContent = data.count;
                    }
                } else {
                    console.error('L·ªói khi l·∫•y s·ªë l∆∞·ª£ng kh√°ch h√†ng:', data.error);
                }
            })
            .catch(error => {
                console.error('L·ªói khi g·ªçi API:', error);
            });
    }

    function fetchDocumentCount() {
        fetch('/api/documents/count', {
            method: 'GET',
            headers: getAuthHeaders()
        })
            .then(response => {
                if (response.status === 401) {
                    console.error('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unauthorized');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const countElement = document.getElementById('document-count');
                    if (countElement) {
                        countElement.style.transition = 'all 0.3s ease';
                        countElement.textContent = data.count;
                    }
                } else {
                    console.error('L·ªói khi l·∫•y s·ªë l∆∞·ª£ng t√†i li·ªáu:', data.error);
                }
            })
            .catch(error => {
                console.error('L·ªói khi g·ªçi API:', error);
            });
    }

    const statsChannel = new BroadcastChannel('dashboard_stats');
    statsChannel.onmessage = function(event) {
        if (event.data && event.data.type === 'stats_update') {
            updateStats(event.data.stats);
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        fetchCustomerCount();
        fetchDocumentCount();
    });
</script>
{% endblock %}

