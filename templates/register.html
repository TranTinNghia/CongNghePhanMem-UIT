{% extends "base.html" %}

{% block title %}ƒêƒÉng k√Ω - BaiTapNhom{% endblock %}

{% block extra_js %}
<script>
// Mapping ph√≤ng ban -> role
const departmentRoleMap = {
    "Ph√≤ng C√¥ng Ngh·ªá Th√¥ng Tin": "ADMIN",
    "T∆∞ L·ªánh V√† C·∫•p Ch·ªâ Huy": "EDITOR",
    "Ph√≤ng T√†i Ch√≠nh - K·∫ø To√°n": "EDITOR",
    "Ph√≤ng Marketing": "EDITOR",
    "Trung T√¢m ƒêi·ªÅu ƒê·ªô": "EDITOR",
    "C√¥ng Ty C·ªï Ph·∫ßn Gi·∫£i Ph√°p CNTT T√¢n C·∫£ng (TCIS)": "EDITOR"
};

function updateRoleDisplay() {
    const departmentSelect = document.getElementById('department_key');
    const roleDisplay = document.getElementById('roleDisplay');
    const roleInput = document.getElementById('roleInput');
    const roleHint = document.getElementById('roleHint');
    
    const selectedOption = departmentSelect.options[departmentSelect.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        roleDisplay.innerHTML = '<span style="color: #718096; font-style: italic;">Vui l√≤ng ch·ªçn ph√≤ng ban ƒë·ªÉ xem vai tr√≤</span>';
        roleInput.value = '';
        roleHint.style.display = 'none';
        return;
    }
    
    const departmentName = selectedOption.getAttribute('data-name');
    if (!departmentName) {
        roleDisplay.innerHTML = '<span style="color: #718096; font-style: italic;">Vui l√≤ng ch·ªçn ph√≤ng ban ƒë·ªÉ xem vai tr√≤</span>';
        roleInput.value = '';
        roleHint.style.display = 'none';
        return;
    }
    
    const role = departmentRoleMap[departmentName] || "VIEWER";
    roleInput.value = role;
    
    let roleBadgeClass = 'role-badge';
    let roleColor = '#718096';
    if (role === 'ADMIN') {
        roleBadgeClass = 'role-badge-admin';
        roleColor = '#c53030';
    } else if (role === 'EDITOR') {
        roleColor = '#2c5282';
    }
    
    const roleIcon = role === 'ADMIN' ? 'üëë ' : role === 'EDITOR' ? '‚úèÔ∏è ' : 'üëÅÔ∏è ';
    const roleBg = role === 'ADMIN' ? '#fed7d7' : role === 'EDITOR' ? '#bee3f8' : '#e2e8f0';
    
    roleDisplay.innerHTML = 
        '<div class="' + roleBadgeClass + '" style="display: inline-block; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background: ' + roleBg + '; color: ' + roleColor + ';">' +
        roleIcon + role +
        '</div>' +
        '<p style="margin-top: 0.5rem; color: #718096; font-size: 0.85rem;">Vai tr√≤ t·ª± ƒë·ªông: ' + departmentName + '</p>';
    roleHint.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('department_key');
    if (departmentSelect) {
        departmentSelect.addEventListener('change', updateRoleDisplay);
    }
});

function handlePhoneChange(e) {
    let value = e.target.value;
    
    // Cho ph√©p d·∫•u + ·ªü ƒë·∫ßu, sau ƒë√≥ ch·ªâ cho ph√©p s·ªë
    if (value.startsWith('+')) {
        const numbersAfterPlus = value.substring(1).replace(/\D/g, '');
        value = '+' + numbersAfterPlus;
        
        // N·∫øu b·∫Øt ƒë·∫ßu b·∫±ng +84, chuy·ªÉn th√†nh 0
        if (value.startsWith('+84')) {
            value = '0' + value.substring(3);
        }
    } else {
        value = value.replace(/\D/g, '');
    }
    
    e.target.value = value;
}

function checkPasswordMatch() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('passwordMatchMessage');
    const confirmInput = document.getElementById('confirmPassword');
    
    // Ch·ªâ ki·ªÉm tra khi c·∫£ 2 tr∆∞·ªùng ƒë·ªÅu c√≥ gi√° tr·ªã
    if (password && confirmPassword) {
        if (password === confirmPassword) {
            messageDiv.textContent = '‚úì M·∫≠t kh·∫©u kh·ªõp';
            messageDiv.className = 'password-match-message password-match-success';
            messageDiv.style.display = 'block';
            confirmInput.style.borderColor = '#28a745';
        } else {
            messageDiv.textContent = '‚úó M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
            messageDiv.className = 'password-match-message password-match-error';
            messageDiv.style.display = 'block';
            confirmInput.style.borderColor = '#dc3545';
        }
    } else {
        messageDiv.style.display = 'none';
        confirmInput.style.borderColor = '#e0e0e0';
    }
}
</script>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>ƒêƒÉng k√Ω</h2>
        <form method="POST" action="{{ url_for('register') }}">
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    required
                    placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                    autocomplete="username"
                />
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    placeholder="Nh·∫≠p email"
                    autocomplete="email"
                />
            </div>

            <div class="form-group">
                <label for="phone_number">S·ªë ƒëi·ªán tho·∫°i</label>
                <input
                    type="tel"
                    id="phone_number"
                    name="phone_number"
                    required
                    placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (VD: +84901234567 ho·∫∑c 0901234567)"
                    oninput="handlePhoneChange(event)"
                />
                <div class="phone-hint">
                    S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 s·ªë. N·∫øu nh·∫≠p +84 s·∫Ω t·ª± ƒë·ªông chuy·ªÉn th√†nh 0
                </div>
            </div>

            <div class="form-group">
                <label for="first_name">H·ªç</label>
                <input
                    type="text"
                    id="first_name"
                    name="first_name"
                    required
                    placeholder="Nh·∫≠p h·ªç"
                    autocomplete="given-name"
                />
            </div>

            <div class="form-group">
                <label for="middle_name">T√™n ƒë·ªám</label>
                <input
                    type="text"
                    id="middle_name"
                    name="middle_name"
                    placeholder="Nh·∫≠p t√™n ƒë·ªám (t√πy ch·ªçn)"
                    autocomplete="additional-name"
                />
            </div>

            <div class="form-group">
                <label for="last_name">T√™n</label>
                <input
                    type="text"
                    id="last_name"
                    name="last_name"
                    required
                    placeholder="Nh·∫≠p t√™n"
                    autocomplete="family-name"
                />
            </div>

            <div class="form-group">
                <label for="department_key">Ph√≤ng ban <span style="color: red;">*</span></label>
                <select id="department_key" name="department_key" required>
                    <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                    {% for dept in departments %}
                    <option value="{{ dept.department_key }}" data-name="{{ dept.department }}">{{ dept.department }}</option>
                    {% endfor %}
                </select>
                <div class="role-hint" id="roleHint" style="margin-top: 0.5rem; padding: 0.5rem; background: #e6f3ff; border-radius: 6px; font-size: 0.85rem; color: #0066cc; display: none;">
                    Vai tr√≤ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông x√°c ƒë·ªãnh d·ª±a tr√™n ph√≤ng ban b·∫°n ch·ªçn
                </div>
            </div>

            <div class="form-group">
                <label for="role">Vai tr√≤</label>
                <div class="role-display-container" id="roleDisplay" style="padding: 0.8rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center;">
                    <span style="color: #718096; font-style: italic;">Vui l√≤ng ch·ªçn ph√≤ng ban ƒë·ªÉ xem vai tr√≤</span>
                </div>
                <input type="hidden" name="role" id="roleInput" value="">
            </div>
            
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u (8 k√Ω t·ª± t·ªëi thi·ªÉu, c√≥ s·ªë, ch·ªØ hoa, ch·ªØ th∆∞·ªùng, k√Ω t·ª± ƒë·∫∑c bi·ªát)"
                    autocomplete="new-password"
                    oninput="checkPasswordMatch()"
                />
                <div class="password-hint">
                    M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, 1 ch·ªØ hoa, 1 ch·ªØ th∆∞·ªùng, 1 s·ªë, 1 k√Ω t·ª± ƒë·∫∑c bi·ªát
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                    autocomplete="new-password"
                    oninput="checkPasswordMatch()"
                />
                <div id="passwordMatchMessage" class="password-match-message" style="display: none;"></div>
            </div>

            <button type="submit" class="submit-btn">ƒêƒÉng k√Ω</button>
        </form>

        <div class="auth-footer">
            <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="{{ url_for('login') }}">ƒêƒÉng nh·∫≠p ngay</a></p>
        </div>
    </div>
</div>
{% endblock %}

