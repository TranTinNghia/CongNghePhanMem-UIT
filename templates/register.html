{% extends "base.html" %}

{% block title %}ƒêƒÉng k√Ω - BaiTapNhom{% endblock %}

{% block extra_js %}
<script>
function handlePhoneChange(e) {
    let value = e.target.value;
    
    // Cho ph√©p d·∫•u + ·ªü ƒë·∫ßu, sau ƒë√≥ ch·ªâ cho ph√©p s·ªë
    if (value.startsWith('+')) {
        const numbersAfterPlus = value.substring(1).replace(/\D/g, '');
        value = '+' + numbersAfterPlus;
        
        // N·∫øu b·∫Øt ƒë·∫ßu b·∫±ng +84, chuy·ªÉn th√†nh 0
        if (value.startsWith('+84')) {
            value = '0' + value.substring(3);
        }
    } else {
        value = value.replace(/\D/g, '');
    }
    
    e.target.value = value;
}

function checkPasswordMatch() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('passwordMatchMessage');
    const confirmInput = document.getElementById('confirmPassword');
    
    // Ch·ªâ ki·ªÉm tra khi c·∫£ 2 tr∆∞·ªùng ƒë·ªÅu c√≥ gi√° tr·ªã
    if (password && confirmPassword) {
        if (password === confirmPassword) {
            messageDiv.textContent = '‚úì M·∫≠t kh·∫©u kh·ªõp';
            messageDiv.className = 'password-match-message password-match-success';
            messageDiv.style.display = 'block';
            confirmInput.style.borderColor = '#28a745';
        } else {
            messageDiv.textContent = '‚úó M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
            messageDiv.className = 'password-match-message password-match-error';
            messageDiv.style.display = 'block';
            confirmInput.style.borderColor = '#dc3545';
        }
    } else {
        messageDiv.style.display = 'none';
        confirmInput.style.borderColor = '#e0e0e0';
    }
}
</script>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>ƒêƒÉng k√Ω</h2>
        {% if is_first_user %}
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <p style="margin: 0; color: #856404; font-weight: 500;">
                ‚ö†Ô∏è L·∫ßn ƒë·∫ßu ƒëƒÉng k√Ω: Vui l√≤ng t·∫°o t√†i kho·∫£n ADMIN ƒë·ªÉ qu·∫£n l√Ω h·ªá th·ªëng.
            </p>
        </div>
        {% endif %}
        <form method="POST" action="{{ url_for('register') }}">
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    required
                    placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                    autocomplete="username"
                />
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    placeholder="Nh·∫≠p email"
                    autocomplete="email"
                />
            </div>

            <div class="form-group">
                <label for="phone_number">S·ªë ƒëi·ªán tho·∫°i</label>
                <input
                    type="tel"
                    id="phone_number"
                    name="phone_number"
                    required
                    placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (VD: +84901234567 ho·∫∑c 0901234567)"
                    oninput="handlePhoneChange(event)"
                />
                <div class="phone-hint">
                    S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 s·ªë. N·∫øu nh·∫≠p +84 s·∫Ω t·ª± ƒë·ªông chuy·ªÉn th√†nh 0
                </div>
            </div>

            <div class="form-group">
                <label for="first_name">H·ªç</label>
                <input
                    type="text"
                    id="first_name"
                    name="first_name"
                    required
                    placeholder="Nh·∫≠p h·ªç"
                    autocomplete="given-name"
                />
            </div>

            <div class="form-group">
                <label for="middle_name">T√™n ƒë·ªám</label>
                <input
                    type="text"
                    id="middle_name"
                    name="middle_name"
                    placeholder="Nh·∫≠p t√™n ƒë·ªám (t√πy ch·ªçn)"
                    autocomplete="additional-name"
                />
            </div>

            <div class="form-group">
                <label for="last_name">T√™n</label>
                <input
                    type="text"
                    id="last_name"
                    name="last_name"
                    required
                    placeholder="Nh·∫≠p t√™n"
                    autocomplete="family-name"
                />
            </div>

            <div class="form-group">
                <label for="department_key">Ph√≤ng ban</label>
                <select id="department_key" name="department_key">
                    <option value="">-- Ch·ªçn ph√≤ng ban (t√πy ch·ªçn) --</option>
                    {% for dept in departments %}
                    <option value="{{ dept.department_key }}">{{ dept.department }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="role">Vai tr√≤</label>
                {% if is_first_user %}
                <div class="role-display-container">
                    <div class="role-badge-admin">
                        <span class="role-icon">üëë</span>
                        <span class="role-text">ADMIN</span>
                    </div>
                    <p class="role-note">Vai tr√≤ m·∫∑c ƒë·ªãnh cho t√†i kho·∫£n ƒë·∫ßu ti√™n</p>
                </div>
                <input type="hidden" name="role" value="ADMIN">
                {% else %}
                <select id="role" name="role" required>
                    <option value="">-- Ch·ªçn vai tr√≤ --</option>
                    {% for role in roles %}
                    <option value="{{ role.role_name }}">{{ role.role_name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u (8 k√Ω t·ª± t·ªëi thi·ªÉu, c√≥ s·ªë, ch·ªØ hoa, ch·ªØ th∆∞·ªùng, k√Ω t·ª± ƒë·∫∑c bi·ªát)"
                    autocomplete="new-password"
                    oninput="checkPasswordMatch()"
                />
                <div class="password-hint">
                    M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, 1 ch·ªØ hoa, 1 ch·ªØ th∆∞·ªùng, 1 s·ªë, 1 k√Ω t·ª± ƒë·∫∑c bi·ªát
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                    autocomplete="new-password"
                    oninput="checkPasswordMatch()"
                />
                <div id="passwordMatchMessage" class="password-match-message" style="display: none;"></div>
            </div>

            <button type="submit" class="submit-btn">ƒêƒÉng k√Ω</button>
        </form>

        <div class="auth-footer">
            <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="{{ url_for('login') }}">ƒêƒÉng nh·∫≠p ngay</a></p>
        </div>
    </div>
</div>
{% endblock %}

