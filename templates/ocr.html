{% extends "base.html" %}

{% block title %}Qu√©t OCR - Application{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ocr.css') }}">
{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="ocr-header">
        <h1>Qu√©t OCR</h1>
        <p class="ocr-subtitle">T·∫£i l√™n file PDF ƒë·ªÉ tr√≠ch xu·∫•t th√¥ng tin</p>
        <div class="scan-mode-selector">
            <label class="mode-option">
                <input type="radio" name="scanMode" value="single" checked onchange="switchScanMode('single')">
                <span>Qu√©t 1 file</span>
            </label>
            <label class="mode-option">
                <input type="radio" name="scanMode" value="multiple" onchange="switchScanMode('multiple')">
                <span>Qu√©t nhi·ªÅu file</span>
            </label>
        </div>
        {% endif %}
    </div>

    <div class="ocr-content">
        <div class="ocr-left">
            <div class="upload-section">
                <div class="upload-box" id="uploadBox">
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <input type="file" id="fileInputMultiple" accept=".pdf" multiple style="display: none;">
                    <div class="upload-icon">üìÑ</div>
                    <p class="upload-text" id="uploadText">K√©o th·∫£ file PDF v√†o ƒë√¢y</p>
                    <p class="upload-subtext">ho·∫∑c</p>
                    <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">Ch·ªçn file t·ª´ m√°y t√≠nh</button>
                    <p class="file-name" id="fileName"></p>
                    <div id="fileList" class="file-list" style="display: none;"></div>
                </div>
                
                <div class="format-notice">
                    <div class="notice-icon">‚ÑπÔ∏è</div>
                    <div class="notice-content">
                        <strong>L∆∞u √Ω v·ªÅ ƒë·ªãnh d·∫°ng file:</strong>
                        <p>File PDF ph·∫£i c√≥ ƒë·ªãnh d·∫°ng gi·ªëng nh∆∞ Gi·∫•y bi√™n nh·∫≠n thanh to√°n d∆∞·ªõi ƒë√¢y m·ªõi th·ª±c hi·ªán ƒë∆∞·ª£c.</p>
                    </div>
                </div>

                <div class="sample-image-section">
                    <h3 class="sample-title">H√¨nh ·∫£nh m·∫´u gi·∫•y bi√™n nh·∫≠n:</h3>
                    <div class="sample-image-container">
                        <img src="{{ url_for('static', filename='images/receipt-sample.png') }}" alt="M·∫´u gi·∫•y bi√™n nh·∫≠n" class="sample-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="sample-placeholder" style="display: none;">
                            <p>H√¨nh ·∫£nh m·∫´u s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y</p>
                            <p class="placeholder-note">ƒê·∫∑t file receipt-sample.png v√†o th∆∞ m·ª•c static/images/</p>
                        </div>
                    </div>
                </div>

                <button class="scan-btn" id="scanBtn" onclick="processOCR()" disabled>
                    <span class="scan-icon">üîç</span>
                    Qu√©t OCR
                </button>
            </div>
        </div>

        <div class="ocr-right">
            <div class="info-section">
                <h2>Th√¥ng tin tr√≠ch xu·∫•t</h2>
                <div id="singleModeInfo" class="info-grid">
                    <div class="info-item">
                        <label>M√£ l√¥ h√†ng:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="lotCode" />
                        {% else %}
                        <div class="info-value" id="lotCodeDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <label>M√£ giao d·ªãch:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="transactionCode" />
                        {% else %}
                        <div class="info-value" id="transactionCodeDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <label>Ng√†y bi√™n nh·∫≠n:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="receiptDate" />
                        {% else %}
                        <div class="info-value" id="receiptDateDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <label>S·ªë h√≥a ƒë∆°n:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="invoiceNumber" />
                        {% else %}
                        <div class="info-value" id="invoiceNumberDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <label>M√£ s·ªë thu·∫ø Kh√°ch h√†ng:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="taxCode" />
                        {% else %}
                        <div class="info-value" id="taxCodeDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <label>T√™n Kh√°ch h√†ng:</label>
                        {% if can_edit %}
                        <input type="text" class="info-input" id="customerName" />
                        {% else %}
                        <div class="info-value" id="customerNameDisplay">-</div>
                        {% endif %}
                    </div>
                    <div class="info-item full-width">
                        <label>ƒê·ªãa ch·ªâ Kh√°ch h√†ng:</label>
                        {% if can_edit %}
                        <textarea class="info-input" id="customerAddress" rows="2"></textarea>
                        {% else %}
                        <div class="info-value" id="customerAddressDisplay">-</div>
                        {% endif %}
                    </div>
                </div>
                {% if can_edit %}
                <div class="action-buttons" id="singleModeActions" style="display: none; margin-top: 20px; gap: 10px;">
                    <button class="btn-confirm" onclick="confirmSaveSingle()">X√°c nh·∫≠n</button>
                    <button class="btn-reset" onclick="resetToOriginalSingle()">Tr·∫£ l·∫°i th√¥ng tin c≈©</button>
                </div>
                {% endif %}
                <div id="multipleModeInfo" class="info-table-container" style="display: none;">
                    <table class="info-table" id="multipleModeTable">
                        <thead>
                            <tr>
                                <th>M√£ l√¥ h√†ng</th>
                                <th>M√£ giao d·ªãch</th>
                                <th>Ng√†y bi√™n nh·∫≠n</th>
                                <th>S·ªë h√≥a ƒë∆°n</th>
                                <th>M√£ s·ªë thu·∫ø</th>
                                <th>T√™n Kh√°ch h√†ng</th>
                                <th>ƒê·ªãa ch·ªâ Kh√°ch h√†ng</th>
                            </tr>
                        </thead>
                        <tbody id="infoTableBody">
                        </tbody>
                    </table>
                </div>
                {% if can_edit %}
                <div class="action-buttons" id="multipleModeActions" style="display: none; margin-top: 20px; gap: 10px;">
                    <button class="btn-confirm" onclick="confirmSaveMultiple()">X√°c nh·∫≠n</button>
                    <button class="btn-reset" onclick="resetToOriginalMultiple()">Tr·∫£ l·∫°i th√¥ng tin c≈©</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="table-section" id="tableSection" style="display: none;">
        <h2>Chi ti·∫øt Container</h2>
        <div class="table-container">
            <table class="ocr-table">
                <thead>
                    <tr>
                        <th>S·ªë Container</th>
                        <th>Ph∆∞∆°ng √°n</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Thu·∫ø (%)</th>
                        <th>Gi·∫£m gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="appConfig" data-can-edit="{% if can_edit %}true{% else %}false{% endif %}" style="display: none;"></div>
<script>
const canEdit = document.getElementById('appConfig').getAttribute('data-can-edit') === 'true';
let selectedFile = null;
let selectedFiles = [];
let scanMode = 'single';

let singleModeResults = null;
let singleModeOriginal = null;
let multipleModeResults = null;
let multipleModeOriginal = null;

function switchScanMode(mode) {
    if (scanMode === 'single' && singleModeResults) {
    } else if (scanMode === 'multiple' && multipleModeResults) {
    }
    
    scanMode = mode;
    
    if (mode === 'single') {
        document.getElementById('uploadText').textContent = 'K√©o th·∫£ file PDF v√†o ƒë√¢y';
        document.getElementById('uploadBtn').onclick = function() { document.getElementById('fileInput').click(); };
        document.getElementById('singleModeInfo').style.display = 'grid';
        document.getElementById('multipleModeInfo').style.display = 'none';
        
        if (singleModeResults) {
            restoreSingleResults(singleModeResults);
        } else {
            if (canEdit) {
                document.getElementById('lotCode').value = '';
                document.getElementById('transactionCode').value = '';
                document.getElementById('receiptDate').value = '';
                document.getElementById('invoiceNumber').value = '';
                document.getElementById('taxCode').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerAddress').value = '';
            } else {
                document.getElementById('lotCodeDisplay').textContent = '-';
                document.getElementById('transactionCodeDisplay').textContent = '-';
                document.getElementById('receiptDateDisplay').textContent = '-';
                document.getElementById('invoiceNumberDisplay').textContent = '-';
                document.getElementById('taxCodeDisplay').textContent = '-';
                document.getElementById('customerNameDisplay').textContent = '-';
                document.getElementById('customerAddressDisplay').textContent = '-';
            }
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('tableSection').style.display = 'none';
            if (canEdit) {
                document.getElementById('singleModeActions').style.display = 'none';
            }
        }
        
        if (selectedFile) {
            document.getElementById('fileName').textContent = selectedFile.name;
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('uploadBox').classList.add('file-selected');
        } else {
            document.getElementById('fileName').textContent = '';
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('uploadBox').classList.remove('file-selected');
        }
    } else {
        document.getElementById('uploadText').textContent = 'K√©o th·∫£ nhi·ªÅu file PDF v√†o ƒë√¢y';
        document.getElementById('uploadBtn').onclick = function() { document.getElementById('fileInputMultiple').click(); };
        document.getElementById('singleModeInfo').style.display = 'none';
        document.getElementById('multipleModeInfo').style.display = 'block';
        
        if (multipleModeResults) {
            restoreMultipleResults(multipleModeResults);
        } else {
            document.getElementById('infoTableBody').innerHTML = '';
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('tableSection').style.display = 'none';
        }
        
        if (selectedFiles && selectedFiles.length > 0) {
            updateFileList();
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('uploadBox').classList.add('file-selected');
        } else {
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('uploadBox').classList.remove('file-selected');
        }
    }
}

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.type !== 'application/pdf') {
            alert('Vui l√≤ng ch·ªçn file PDF!');
            return;
        }
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('uploadBox').classList.add('file-selected');
    }
});

document.getElementById('fileInputMultiple').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const pdfFiles = files.filter(file => file.type === 'application/pdf');
    
    if (pdfFiles.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file PDF!');
        return;
    }
    
    selectedFiles = pdfFiles;
    updateFileList();
    document.getElementById('scanBtn').disabled = false;
    document.getElementById('uploadBox').classList.add('file-selected');
});

function updateFileList() {
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '<strong>ƒê√£ ch·ªçn ' + selectedFiles.length + ' file:</strong><ul>';
    selectedFiles.forEach((file, index) => {
        fileListDiv.innerHTML += '<li>' + file.name + '</li>';
    });
    fileListDiv.innerHTML += '</ul>';
    fileListDiv.style.display = 'block';
}

const uploadBox = document.getElementById('uploadBox');
uploadBox.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadBox.classList.add('drag-over');
});

uploadBox.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadBox.classList.remove('drag-over');
});

uploadBox.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadBox.classList.remove('drag-over');
    
    if (scanMode === 'single') {
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'application/pdf') {
            selectedFile = file;
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById('fileInput').files = dataTransfer.files;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('scanBtn').disabled = false;
            uploadBox.classList.add('file-selected');
        } else {
            alert('Vui l√≤ng ch·ªçn file PDF!');
        }
    } else {
        const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
        if (files.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file PDF!');
            return;
        }
        selectedFiles = files;
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        document.getElementById('fileInputMultiple').files = dataTransfer.files;
        updateFileList();
        document.getElementById('scanBtn').disabled = false;
        uploadBox.classList.add('file-selected');
    }
});

function processOCR() {
    const scanBtn = document.getElementById('scanBtn');
    
    if (scanMode === 'single') {
        if (!selectedFile) {
            alert('Vui l√≤ng ch·ªçn file PDF!');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedFile);

        scanBtn.disabled = true;
        scanBtn.innerHTML = '<span class="scan-icon">‚è≥</span> ƒêang qu√©t...';

        fetch('{{ url_for("ocr_process") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.data);
                if (data.stats) {
                    const statsChannel = new BroadcastChannel('dashboard_stats');
                    statsChannel.postMessage({
                        type: 'stats_update',
                        stats: data.stats
                    });
                    statsChannel.close();
                }
                const dashboardChannel = new BroadcastChannel('dashboard-updates');
                dashboardChannel.postMessage({ type: 'data-updated' });
                dashboardChannel.close();
            } else {
                alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ qu√©t file'));
            }
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<span class="scan-icon">üîç</span> Qu√©t OCR';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi qu√©t file');
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<span class="scan-icon">üîç</span> Qu√©t OCR';
        });
    } else {
        if (selectedFiles.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file PDF!');
            return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });

        scanBtn.disabled = true;
        scanBtn.innerHTML = '<span class="scan-icon">‚è≥</span> ƒêang qu√©t...';

        fetch('{{ url_for("ocr_process_multiple") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMultipleResults(data.data);
                if (data.stats) {
                    const statsChannel = new BroadcastChannel('dashboard_stats');
                    statsChannel.postMessage({
                        type: 'stats_update',
                        stats: data.stats
                    });
                    statsChannel.close();
                }
                const dashboardChannel = new BroadcastChannel('dashboard-updates');
                dashboardChannel.postMessage({ type: 'data-updated' });
                dashboardChannel.close();
            } else {
                alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ qu√©t file'));
            }
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<span class="scan-icon">üîç</span> Qu√©t OCR';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi qu√©t file');
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<span class="scan-icon">üîç</span> Qu√©t OCR';
        });
    }
}

function displayResults(data) {
    singleModeResults = JSON.parse(JSON.stringify(data));
    singleModeOriginal = JSON.parse(JSON.stringify(data));
    
    if (canEdit) {
        document.getElementById('lotCode').value = data.lot_code || '';
        document.getElementById('transactionCode').value = data.transaction_code || '';
        document.getElementById('receiptDate').value = data.receipt_date || '';
        document.getElementById('invoiceNumber').value = data.invoice_number || '';
        document.getElementById('taxCode').value = data.tax_code || '';
        document.getElementById('customerName').value = data.customer_name || '';
        document.getElementById('customerAddress').value = data.customer_address || '';
        document.getElementById('singleModeActions').style.display = 'flex';
    } else {
        document.getElementById('lotCodeDisplay').textContent = data.lot_code || '-';
        document.getElementById('transactionCodeDisplay').textContent = data.transaction_code || '-';
        document.getElementById('receiptDateDisplay').textContent = data.receipt_date || '-';
        document.getElementById('invoiceNumberDisplay').textContent = data.invoice_number || '-';
        document.getElementById('taxCodeDisplay').textContent = data.tax_code || '-';
        document.getElementById('customerNameDisplay').textContent = data.customer_name || '-';
        document.getElementById('customerAddressDisplay').textContent = data.customer_address || '-';
    }

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (data.items && data.items.length > 0) {
        data.items.forEach((item, index) => {
            const row = document.createElement('tr');
            if (canEdit) {
                row.innerHTML = `
                    <td><input type="text" class="table-input" data-field="container_number" data-index="${index}" value="${item.container_number || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="option" data-index="${index}" value="${item.option || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="quantity" data-index="${index}" value="${item.quantity || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="unit_price" data-index="${index}" value="${item.unit_price || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="tax" data-index="${index}" value="${item.tax || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="discount" data-index="${index}" value="${item.discount || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="amount" data-index="${index}" value="${item.amount || ''}" /></td>
                `;
            } else {
            row.innerHTML = `
                <td>${item.container_number || '-'}</td>
                <td>${item.option || '-'}</td>
                <td>${item.quantity || '-'}</td>
                <td>${item.unit_price ? formatNumber(item.unit_price) : '-'}</td>
                <td>${item.tax || '-'}</td>
                <td>${item.discount ? formatNumber(item.discount) : '-'}</td>
                <td>${item.amount ? formatNumber(item.amount) : '-'}</td>
            `;
            }
            tableBody.appendChild(row);
        });
        document.getElementById('tableSection').style.display = 'block';
    } else {
        document.getElementById('tableSection').style.display = 'none';
    }
}

function restoreSingleResults(data) {
    if (canEdit) {
        document.getElementById('lotCode').value = data.lot_code || '';
        document.getElementById('transactionCode').value = data.transaction_code || '';
        document.getElementById('receiptDate').value = data.receipt_date || '';
        document.getElementById('invoiceNumber').value = data.invoice_number || '';
        document.getElementById('taxCode').value = data.tax_code || '';
        document.getElementById('customerName').value = data.customer_name || '';
        document.getElementById('customerAddress').value = data.customer_address || '';
    } else {
        document.getElementById('lotCodeDisplay').textContent = data.lot_code || '-';
        document.getElementById('transactionCodeDisplay').textContent = data.transaction_code || '-';
        document.getElementById('receiptDateDisplay').textContent = data.receipt_date || '-';
        document.getElementById('invoiceNumberDisplay').textContent = data.invoice_number || '-';
        document.getElementById('taxCodeDisplay').textContent = data.tax_code || '-';
        document.getElementById('customerNameDisplay').textContent = data.customer_name || '-';
        document.getElementById('customerAddressDisplay').textContent = data.customer_address || '-';
    }

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (data.items && data.items.length > 0) {
        data.items.forEach((item, index) => {
            const row = document.createElement('tr');
            if (canEdit) {
                row.innerHTML = `
                    <td><input type="text" class="table-input" data-field="container_number" data-index="${index}" value="${item.container_number || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="option" data-index="${index}" value="${item.option || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="quantity" data-index="${index}" value="${item.quantity || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="unit_price" data-index="${index}" value="${item.unit_price || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="tax" data-index="${index}" value="${item.tax || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="discount" data-index="${index}" value="${item.discount || ''}" /></td>
                    <td><input type="text" class="table-input" data-field="amount" data-index="${index}" value="${item.amount || ''}" /></td>
                `;
            } else {
            row.innerHTML = `
                <td>${item.container_number || '-'}</td>
                <td>${item.option || '-'}</td>
                <td>${item.quantity || '-'}</td>
                <td>${item.unit_price ? formatNumber(item.unit_price) : '-'}</td>
                <td>${item.tax || '-'}</td>
                <td>${item.discount ? formatNumber(item.discount) : '-'}</td>
                <td>${item.amount ? formatNumber(item.amount) : '-'}</td>
            `;
            }
            tableBody.appendChild(row);
        });
        document.getElementById('tableSection').style.display = 'block';
    } else {
        document.getElementById('tableSection').style.display = 'none';
    }
}

function displayMultipleResults(results) {
    multipleModeResults = JSON.parse(JSON.stringify(results));
    multipleModeOriginal = JSON.parse(JSON.stringify(results));
    
    const infoTableBody = document.getElementById('infoTableBody');
    infoTableBody.innerHTML = '';
    
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    results.forEach((result, resultIndex) => {
        const infoRow = document.createElement('tr');
        if (canEdit) {
            infoRow.innerHTML = `
                <td><input type="text" class="table-input" data-field="lot_code" data-result-index="${resultIndex}" value="${result.lot_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="transaction_code" data-result-index="${resultIndex}" value="${result.transaction_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="receipt_date" data-result-index="${resultIndex}" value="${result.receipt_date || ''}" /></td>
                <td><input type="text" class="table-input" data-field="invoice_number" data-result-index="${resultIndex}" value="${result.invoice_number || ''}" /></td>
                <td><input type="text" class="table-input" data-field="tax_code" data-result-index="${resultIndex}" value="${result.tax_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="customer_name" data-result-index="${resultIndex}" value="${result.customer_name || ''}" /></td>
                <td><input type="text" class="table-input" data-field="customer_address" data-result-index="${resultIndex}" value="${result.customer_address || ''}" /></td>
            `;
        } else {
        infoRow.innerHTML = `
            <td>${result.lot_code || '-'}</td>
            <td>${result.transaction_code || '-'}</td>
            <td>${result.receipt_date || '-'}</td>
            <td>${result.invoice_number || '-'}</td>
            <td>${result.tax_code || '-'}</td>
            <td>${result.customer_name || '-'}</td>
            <td>${result.customer_address || '-'}</td>
        `;
        }
        infoTableBody.appendChild(infoRow);
        
        if (result.items && result.items.length > 0) {
            result.items.forEach((item, itemIndex) => {
                const row = document.createElement('tr');
                if (canEdit) {
                    row.innerHTML = `
                        <td><input type="text" class="table-input" data-field="container_number" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.container_number || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="option" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.option || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="quantity" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.quantity || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="unit_price" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.unit_price || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="tax" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.tax || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="discount" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.discount || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="amount" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.amount || ''}" /></td>
                    `;
                } else {
                row.innerHTML = `
                    <td>${item.container_number || '-'}</td>
                    <td>${item.option || '-'}</td>
                    <td>${item.quantity || '-'}</td>
                    <td>${item.unit_price ? formatNumber(item.unit_price) : '-'}</td>
                    <td>${item.tax || '-'}</td>
                    <td>${item.discount ? formatNumber(item.discount) : '-'}</td>
                    <td>${item.amount ? formatNumber(item.amount) : '-'}</td>
                `;
                }
                tableBody.appendChild(row);
            });
        }
    });
    
    if (results.length > 0) {
        document.getElementById('tableSection').style.display = 'block';
        if (canEdit) {
            document.getElementById('multipleModeActions').style.display = 'flex';
        }
    }
}

function restoreMultipleResults(results) {
    const infoTableBody = document.getElementById('infoTableBody');
    infoTableBody.innerHTML = '';
    
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    results.forEach((result, resultIndex) => {
        const infoRow = document.createElement('tr');
        if (canEdit) {
            infoRow.innerHTML = `
                <td><input type="text" class="table-input" data-field="lot_code" data-result-index="${resultIndex}" value="${result.lot_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="transaction_code" data-result-index="${resultIndex}" value="${result.transaction_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="receipt_date" data-result-index="${resultIndex}" value="${result.receipt_date || ''}" /></td>
                <td><input type="text" class="table-input" data-field="invoice_number" data-result-index="${resultIndex}" value="${result.invoice_number || ''}" /></td>
                <td><input type="text" class="table-input" data-field="tax_code" data-result-index="${resultIndex}" value="${result.tax_code || ''}" /></td>
                <td><input type="text" class="table-input" data-field="customer_name" data-result-index="${resultIndex}" value="${result.customer_name || ''}" /></td>
                <td><input type="text" class="table-input" data-field="customer_address" data-result-index="${resultIndex}" value="${result.customer_address || ''}" /></td>
            `;
        } else {
        infoRow.innerHTML = `
            <td>${result.lot_code || '-'}</td>
            <td>${result.transaction_code || '-'}</td>
            <td>${result.receipt_date || '-'}</td>
            <td>${result.invoice_number || '-'}</td>
            <td>${result.tax_code || '-'}</td>
            <td>${result.customer_name || '-'}</td>
            <td>${result.customer_address || '-'}</td>
        `;
        }
        infoTableBody.appendChild(infoRow);
        
        if (result.items && result.items.length > 0) {
            result.items.forEach((item, itemIndex) => {
                const row = document.createElement('tr');
                if (canEdit) {
                    row.innerHTML = `
                        <td><input type="text" class="table-input" data-field="container_number" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.container_number || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="option" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.option || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="quantity" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.quantity || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="unit_price" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.unit_price || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="tax" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.tax || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="discount" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.discount || ''}" /></td>
                        <td><input type="text" class="table-input" data-field="amount" data-result-index="${resultIndex}" data-item-index="${itemIndex}" value="${item.amount || ''}" /></td>
                    `;
                } else {
                row.innerHTML = `
                    <td>${item.container_number || '-'}</td>
                    <td>${item.option || '-'}</td>
                    <td>${item.quantity || '-'}</td>
                    <td>${item.unit_price ? formatNumber(item.unit_price) : '-'}</td>
                    <td>${item.tax || '-'}</td>
                    <td>${item.discount ? formatNumber(item.discount) : '-'}</td>
                    <td>${item.amount ? formatNumber(item.amount) : '-'}</td>
                `;
                }
                tableBody.appendChild(row);
            });
        }
    });
    
    if (results.length > 0) {
        document.getElementById('tableSection').style.display = 'block';
    }
}

function disableAllInputs() {
    const allInputs = document.querySelectorAll('#singleModeInfo input, #singleModeInfo textarea, #multipleModeInfo input, #tableBody input');
    allInputs.forEach(input => {
        input.disabled = true;
    });
    
    const confirmBtn = document.querySelector('#singleModeActions .btn-confirm');
    const resetBtn = document.querySelector('#singleModeActions .btn-reset');
    const confirmBtnMultiple = document.querySelector('#multipleModeActions .btn-confirm');
    const resetBtnMultiple = document.querySelector('#multipleModeActions .btn-reset');
    
    if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'ƒêang l∆∞u...';
    }
    if (resetBtn) resetBtn.disabled = true;
    if (confirmBtnMultiple) {
        confirmBtnMultiple.disabled = true;
        confirmBtnMultiple.textContent = 'ƒêang l∆∞u...';
    }
    if (resetBtnMultiple) resetBtnMultiple.disabled = true;
}

function enableAllInputs() {
    const allInputs = document.querySelectorAll('#singleModeInfo input, #singleModeInfo textarea, #multipleModeInfo input, #tableBody input');
    allInputs.forEach(input => {
        input.disabled = false;
    });
    
    const confirmBtn = document.querySelector('#singleModeActions .btn-confirm');
    const resetBtn = document.querySelector('#singleModeActions .btn-reset');
    const confirmBtnMultiple = document.querySelector('#multipleModeActions .btn-confirm');
    const resetBtnMultiple = document.querySelector('#multipleModeActions .btn-reset');
    
    if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'X√°c nh·∫≠n';
    }
    if (resetBtn) resetBtn.disabled = false;
    if (confirmBtnMultiple) {
        confirmBtnMultiple.disabled = false;
        confirmBtnMultiple.textContent = 'X√°c nh·∫≠n';
    }
    if (resetBtnMultiple) resetBtnMultiple.disabled = false;
}

function confirmSaveSingle() {
    if (!canEdit) {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y');
        return;
    }
    
    disableAllInputs();
    
    const data = {
        lot_code: document.getElementById('lotCode').value,
        transaction_code: document.getElementById('transactionCode').value,
        receipt_date: document.getElementById('receiptDate').value,
        invoice_number: document.getElementById('invoiceNumber').value,
        tax_code: document.getElementById('taxCode').value,
        customer_name: document.getElementById('customerName').value,
        customer_address: document.getElementById('customerAddress').value,
        items: []
    };
    
    const tableRows = document.querySelectorAll('#tableBody tr');
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 7) {
            data.items.push({
                container_number: inputs[0].value,
                option: inputs[1].value,
                quantity: inputs[2].value,
                unit_price: inputs[3].value ? parseInt(inputs[3].value.replace(/,/g, '')) : 0,
                tax: inputs[4].value,
                discount: inputs[5].value ? parseInt(inputs[5].value.replace(/,/g, '')) : 0,
                amount: inputs[6].value ? parseInt(inputs[6].value.replace(/,/g, '')) : 0
            });
        }
    });
    
    fetch('{{ url_for("ocr_save") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            ...data,
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(result => {
                enableAllInputs();
                alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu'));
            });
        }
        return response.json();
    })
    .then(result => {
        if (!result) return;
        
        enableAllInputs();
        if (result.success) {
            alert('L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!');
            if (result.stats) {
                const statsChannel = new BroadcastChannel('dashboard_stats');
                statsChannel.postMessage({
                    type: 'stats_update',
                    stats: result.stats
                });
                statsChannel.close();
            }
            const dashboardChannel = new BroadcastChannel('dashboard-updates');
            dashboardChannel.postMessage({ type: 'data-updated' });
            dashboardChannel.close();
        } else {
            alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        enableAllInputs();
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu');
    });
}

function resetToOriginalSingle() {
    if (!canEdit || !singleModeOriginal) {
        return;
    }
    
    restoreSingleResults(singleModeOriginal);
    singleModeResults = JSON.parse(JSON.stringify(singleModeOriginal));
}

function confirmSaveMultiple() {
    if (!canEdit) {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y');
        return;
    }
    
    disableAllInputs();
    
    const results = [];
    const infoRows = document.querySelectorAll('#infoTableBody tr');
    const tableRows = document.querySelectorAll('#tableBody tr');
    
    infoRows.forEach((infoRow, resultIndex) => {
        const inputs = infoRow.querySelectorAll('input');
        if (inputs.length >= 7) {
            const result = {
                lot_code: inputs[0].value,
                transaction_code: inputs[1].value,
                receipt_date: inputs[2].value,
                invoice_number: inputs[3].value,
                tax_code: inputs[4].value,
                customer_name: inputs[5].value,
                customer_address: inputs[6].value,
                items: []
            };
            
            tableRows.forEach(row => {
                const rowInputs = row.querySelectorAll('input');
                if (rowInputs.length >= 7) {
                    const resultIdx = parseInt(rowInputs[0].getAttribute('data-result-index'));
                    if (resultIdx === resultIndex) {
                        result.items.push({
                            container_number: rowInputs[0].value,
                            option: rowInputs[1].value,
                            quantity: rowInputs[2].value,
                            unit_price: rowInputs[3].value ? parseInt(rowInputs[3].value.replace(/,/g, '')) : 0,
                            tax: rowInputs[4].value,
                            discount: rowInputs[5].value ? parseInt(rowInputs[5].value.replace(/,/g, '')) : 0,
                            amount: rowInputs[6].value ? parseInt(rowInputs[6].value.replace(/,/g, '')) : 0
                        });
                    }
                }
            });
            
            results.push(result);
        }
    });
    
    fetch('{{ url_for("ocr_save") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            is_multiple: true,
            data: results
        })
    })
    .then(response => response.json())
    .then(result => {
        enableAllInputs();
        if (result.success) {
            alert('L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!');
            if (result.stats) {
                const statsChannel = new BroadcastChannel('dashboard_stats');
                statsChannel.postMessage({
                    type: 'stats_update',
                    stats: result.stats
                });
                statsChannel.close();
            }
            const dashboardChannel = new BroadcastChannel('dashboard-updates');
            dashboardChannel.postMessage({ type: 'data-updated' });
            dashboardChannel.close();
        } else {
            alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        enableAllInputs();
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu');
    });
}

function resetToOriginalMultiple() {
    if (!canEdit || !multipleModeOriginal) {
        return;
    }
    
    restoreMultipleResults(multipleModeOriginal);
    multipleModeResults = JSON.parse(JSON.stringify(multipleModeOriginal));
}

function formatNumber(num) {
    return new Intl.NumberFormat('vi-VN').format(num);
}

</script>
{% endblock %}

