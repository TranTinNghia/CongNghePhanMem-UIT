{% extends "base.html" %}

{% block title %}Thông tin tài khoản - BaiTapNhom{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>Thông tin tài khoản</h2>
        <form method="POST" action="{{ url_for('account_settings') }}">
            <div class="form-group">
                <label for="username">Tên đăng nhập</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    value="{{ username }}"
                    disabled
                    class="disabled-input"
                />
                <p class="field-note">Tên đăng nhập không thể thay đổi</p>
            </div>

            {% set full_name = (first_name or '') + ' ' + (middle_name or '') + ' ' + (last_name or '') %}
            {% set full_name = full_name.strip() %}
            <div class="form-group">
                <label>Họ và tên</label>
                <input
                    type="text"
                    id="full_name"
                    value="{{ full_name if full_name else 'Chưa cập nhật' }}"
                    disabled
                    class="disabled-input"
                />
            </div>

            <div class="form-group">
                <label for="first_name">Họ</label>
                <input
                    type="text"
                    id="first_name"
                    name="first_name"
                    value="{{ first_name or '' }}"
                    placeholder="Nhập họ"
                    oninput="updateFullName()"
                />
            </div>

            <div class="form-group">
                <label for="middle_name">Tên đệm</label>
                <input
                    type="text"
                    id="middle_name"
                    name="middle_name"
                    value="{{ middle_name or '' }}"
                    placeholder="Nhập tên đệm"
                    oninput="updateFullName()"
                />
            </div>

            <div class="form-group">
                <label for="last_name">Tên</label>
                <input
                    type="text"
                    id="last_name"
                    name="last_name"
                    value="{{ last_name or '' }}"
                    placeholder="Nhập tên"
                    oninput="updateFullName()"
                />
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    value="{{ email }}"
                    required
                    placeholder="Nhập email"
                />
            </div>

            <div class="form-group">
                <label for="phone_number">Số điện thoại</label>
                <input
                    type="tel"
                    id="phone_number"
                    name="phone_number"
                    value="{{ phone_number }}"
                    required
                    placeholder="Nhập số điện thoại (VD: +84901234567 hoặc 0901234567)"
                    oninput="handlePhoneChange(this)"
                />
                <div class="phone-hint">
                    Số điện thoại phải có 10 số. Nếu nhập +84 sẽ tự động chuyển thành 0
                </div>
            </div>

            <div class="form-group">
                <label for="department_key">Phòng ban</label>
                {% if is_admin %}
                <select id="department_key" name="department_key">
                    <option value="">-- Chọn phòng ban --</option>
                    {% for dept in departments %}
                    <option value="{{ dept.department_key }}" {% if department_key == dept.department_key %}selected{% endif %}>
                        {{ dept.department }}
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <input
                    type="text"
                    value="{{ department if department else 'Chưa cập nhật' }}"
                    disabled
                    class="disabled-input"
                />
                <p class="field-note">Liên hệ ADMIN để chỉnh sửa phòng ban</p>
                {% endif %}
            </div>

            <div class="section-divider">
                <h3>Đổi mật khẩu</h3>
                <p class="section-note">Để trống nếu không muốn đổi mật khẩu</p>
            </div>

            <div class="form-group">
                <label for="current_password">Mật khẩu hiện tại</label>
                <input
                    type="password"
                    id="current_password"
                    name="current_password"
                    placeholder="Nhập mật khẩu hiện tại (nếu đổi mật khẩu)"
                />
            </div>

            <div class="form-group">
                <label for="new_password">Mật khẩu mới</label>
                <input
                    type="password"
                    id="new_password"
                    name="new_password"
                    placeholder="Nhập mật khẩu mới (8 ký tự tối thiểu, có số, chữ hoa, chữ thường, ký tự đặc biệt)"
                />
                <div class="password-hint">
                    Mật khẩu phải có ít nhất 8 ký tự, 1 chữ hoa, 1 chữ thường, 1 số, 1 ký tự đặc biệt
                </div>
            </div>

            <div class="form-group">
                <label for="confirm_password">Xác nhận mật khẩu mới</label>
                <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    placeholder="Nhập lại mật khẩu mới"
                />
            </div>

            <div class="form-actions">
                <button type="submit" class="submit-btn">Cập nhật thông tin</button>
                <a href="{{ url_for('home') }}" class="back-btn">Quay lại</a>
            </div>
        </form>
    </div>
</div>

<script>
function handlePhoneChange(input) {
    let value = input.value;
    
    // Cho phép dấu + ở đầu, sau đó chỉ cho phép số
    if (value.startsWith('+')) {
        const numbersAfterPlus = value.substring(1).replace(/\D/g, '');
        value = '+' + numbersAfterPlus;
        
        // Nếu bắt đầu bằng +84, chuyển thành 0
        if (value.startsWith('+84')) {
            value = '0' + value.substring(3);
        }
    } else {
        // Nếu không có dấu +, chỉ cho phép số
        value = value.replace(/\D/g, '');
    }
    
    input.value = value;
}

function updateFullName() {
    const firstName = document.getElementById('first_name').value.trim();
    const middleName = document.getElementById('middle_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    
    const fullNameParts = [firstName, middleName, lastName].filter(part => part.length > 0);
    const fullName = fullNameParts.join(' ') || 'Chưa cập nhật';
    
    document.getElementById('full_name').value = fullName;
}
</script>
{% endblock %}

