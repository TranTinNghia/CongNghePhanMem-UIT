{% extends "base.html" %}

{% block title %}Test - Application{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/test.css') }}">
{% endblock %}

{% block content %}
{% if test_mode %}
<div class="test-mode-banner" style="position: fixed; top: 0; left: 0; right: 0; background: #ff9800; color: white; padding: 15px; text-align: center; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
    <span style="font-weight: bold; font-size: 16px;">üß™ Test ch∆∞∆°ng tr√¨nh ƒëang ch·∫°y</span>
</div>
<div style="margin-top: 60px;"></div>
{% endif %}
<div class="test-container">
    <div class="test-header">
        <h1>Ch·∫°y Test</h1>
        <p class="test-subtitle">Ch·ªçn test case c·∫ßn ch·∫°y v√† xem k·∫øt qu·∫£ chi ti·∫øt</p>
    </div>

    <div class="test-selection">
        <h2>Ch·ªçn Test Case</h2>
        <div class="test-list" id="testList">
            <div class="loading">ƒêang t·∫£i danh s√°ch test cases...</div>
        </div>
    </div>

    <div class="test-results" id="testResults" style="display: none;">
        <div class="test-result-header">
            <h2 id="testResultTitle">K·∫øt qu·∫£ test</h2>
            <button class="btn-close" onclick="closeResults()">‚úï ƒê√≥ng</button>
        </div>
        
        <div class="test-summary" id="testSummary">
        </div>
        
        <div class="test-steps" id="testSteps">
        </div>
        
        <div class="test-details" id="testDetails">
        </div>
    </div>
</div>

<script>
let availableTests = [];

function loadTests() {
    fetch('{{ url_for("list_tests") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableTests = data.tests;
                displayTestList();
            } else {
                alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch test'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch test');
        });
}

function displayTestList() {
    const testListDiv = document.getElementById('testList');
    
    if (availableTests.length === 0) {
        testListDiv.innerHTML = '<div class="no-tests">Kh√¥ng t√¨m th·∫•y test case n√†o</div>';
        return;
    }
    
    testListDiv.innerHTML = availableTests.map((test, index) => `
        <div class="test-item-card" onclick="runTest('${test.module}')">
            <div class="test-item-number">${index + 1}</div>
            <div class="test-item-content">
                <div class="test-item-name">${test.name}</div>
                <div class="test-item-description">${test.description}</div>
            </div>
            <div class="test-item-action">
                <span class="test-run-icon">‚ñ∂</span>
            </div>
        </div>
    `).join('');
}

function runTest(module) {
    if (module === 'test.test_case.test_case_1_user_permissions') {
        sessionStorage.setItem('testMode', 'true');
        sessionStorage.setItem('testCase', '1');
        sessionStorage.setItem('testActions', JSON.stringify([]));
        
        window.location.href = '{{ url_for("login") }}?test_mode=true&test_case=1';
        return;
    }
    
    if (module === 'test.test_case.test_case_2_single_file') {
        window.location.href = '{{ url_for("ocr") }}?test_mode=true&test_case=2';
        return;
    }
    
    const resultsDiv = document.getElementById('testResults');
    const summaryDiv = document.getElementById('testSummary');
    const stepsDiv = document.getElementById('testSteps');
    const detailsDiv = document.getElementById('testDetails');
    const titleDiv = document.getElementById('testResultTitle');
    
    const testInfo = availableTests.find(t => t.module === module);
    if (testInfo) {
        titleDiv.textContent = testInfo.name;
    }
    
    resultsDiv.style.display = 'block';
    summaryDiv.innerHTML = '<div class="loading">ƒêang ch·∫°y test...</div>';
    stepsDiv.innerHTML = '';
    detailsDiv.innerHTML = '';
    
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
    
    fetch('{{ url_for("run_test") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ module: module })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTestResult(data.result);
        } else {
            summaryDiv.innerHTML = `<div class="error-message">L·ªói: ${data.error || 'Kh√¥ng th·ªÉ ch·∫°y test'}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        summaryDiv.innerHTML = '<div class="error-message">C√≥ l·ªói x·∫£y ra khi ch·∫°y test</div>';
    });
}

function displayTestResult(result) {
    const summaryDiv = document.getElementById('testSummary');
    const stepsDiv = document.getElementById('testSteps');
    const detailsDiv = document.getElementById('testDetails');
    
    const passed = result.passed;
    const statusClass = passed ? 'test-pass' : 'test-fail';
    const statusIcon = passed ? '‚úì' : '‚úó';
    const statusText = passed ? 'PASSED' : 'FAILED';
    
    summaryDiv.innerHTML = `
        <div class="test-status ${statusClass}">
            <span class="status-icon">${statusIcon}</span>
            <span class="status-text">${statusText}</span>
        </div>
        <div class="test-message">${result.message || ''}</div>
    `;
    
    if (result.steps && result.steps.length > 0) {
        stepsDiv.innerHTML = '<h3>Chi ti·∫øt t·ª´ng b∆∞·ªõc</h3>';
        
        result.steps.forEach((step, index) => {
            const stepDiv = document.createElement('div');
            stepDiv.className = `test-step test-step-${step.status}`;
            
            const statusIcon = step.status === 'success' ? '‚úì' : step.status === 'fail' ? '‚úó' : step.status === 'skip' ? '‚äò' : '‚Ñπ';
            
            stepDiv.innerHTML = `
                <div class="step-header">
                    <span class="step-icon">${statusIcon}</span>
                    <span class="step-name">${step.step_name}</span>
                </div>
                <div class="step-message">${step.message || ''}</div>
                ${step.data ? `
                    <div class="step-data-toggle" onclick="toggleStepData(${index})">
                        <span id="stepToggleIcon${index}">‚ñº</span> Xem d·ªØ li·ªáu
                    </div>
                    <div class="step-data" id="stepData${index}" style="display: none;">
                        <pre>${JSON.stringify(step.data, null, 2)}</pre>
                    </div>
                ` : ''}
            `;
            
            stepsDiv.appendChild(stepDiv);
        });
    } else {
        stepsDiv.innerHTML = '<div class="no-steps">Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt c√°c b∆∞·ªõc</div>';
    }
    
    if (result.details && Object.keys(result.details).length > 0) {
        detailsDiv.innerHTML = `
            <h3>Th√¥ng tin chi ti·∫øt</h3>
            <div class="test-details-content">
                <pre>${JSON.stringify(result.details, null, 2)}</pre>
            </div>
        `;
    } else {
        detailsDiv.innerHTML = '';
    }
}

function toggleStepData(index) {
    const dataDiv = document.getElementById(`stepData${index}`);
    const iconSpan = document.getElementById(`stepToggleIcon${index}`);
    
    if (dataDiv.style.display === 'none') {
        dataDiv.style.display = 'block';
        iconSpan.textContent = '‚ñ≤';
    } else {
        dataDiv.style.display = 'none';
        iconSpan.textContent = '‚ñº';
    }
}

function closeResults() {
    document.getElementById('testResults').style.display = 'none';
}

window.onload = function() {
    loadTests();
    
    const urlParams = new URLSearchParams(window.location.search);
    const testCase = urlParams.get('test_case');
    
    if (testCase === '1') {
        const testActionsStr = sessionStorage.getItem('testActions');
        const testMode = sessionStorage.getItem('testMode');
        
        if (testMode === 'true' && testActionsStr) {
            try {
                const testActions = JSON.parse(testActionsStr);
                if (testActions && testActions.length > 0) {
                    fetch('{{ url_for("run_test") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            module: 'test.test_case.test_case_1_user_permissions',
                            test_actions: testActionsStr
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const resultsDiv = document.getElementById('testResults');
                            const titleDiv = document.getElementById('testResultTitle');
                            titleDiv.textContent = data.result.test_name;
                            resultsDiv.style.display = 'block';
                            displayTestResult(data.result);
                            resultsDiv.scrollIntoView({ behavior: 'smooth' });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    
                    sessionStorage.removeItem('testMode');
                    sessionStorage.removeItem('testCase');
                    sessionStorage.removeItem('testActions');
                }
            } catch (e) {
                console.error('Error parsing test actions:', e);
            }
        }
    } else if (testCase === '2') {
        const testResultStr = sessionStorage.getItem('testResult');
        if (testResultStr) {
            try {
                const testResult = JSON.parse(testResultStr);
                sessionStorage.removeItem('testResult');
                
                const resultsDiv = document.getElementById('testResults');
                const titleDiv = document.getElementById('testResultTitle');
                titleDiv.textContent = testResult.test_name;
                resultsDiv.style.display = 'block';
                displayTestResult(testResult);
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('Error parsing test result:', e);
            }
        }
    }
};
</script>
{% endblock %}
